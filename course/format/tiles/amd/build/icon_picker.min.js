define(["jquery","core/templates","core/ajax","core/str","core/notification"],function(a,b,c,d,e){"use strict";var f,g={pickAnIcon:""},h=[],i=function(f,g,h,i,j,k){var l={icon:h,courseid:k,sectionid:f},m=c.call([{methodname:"format_tiles_set_icon",args:l}]);m[0].done(function(c){if(c===!0)if("course-view-tiles"===j){var k=a("#tileicon_"+g).find(".icon");k.animate({opacity:0},500,function(){b.render("format_tiles/tileicon",{tileicon:h,tileid:g,secid:f}).done(function(b){k.fadeOut(0).replaceWith(a(b).find(".icon")).animate({opacity:1},500)})})}else if("course-edit"===j||"course-editsection"===j){var l=a("#id_defaulttileicon");"course-editsection"===j&&(l=a("#id_tileicon")),l.val(h),b.renderPix("tileicon/"+h,"format_tiles",i).done(function(b){a("#selectedicon").html(b),"course-editsection"===j&&d.get_strings([{key:"tip",component:"format_tiles"},{key:"tileselecttip",component:"format_tiles"}]).done(function(a){e.alert(a[0],a[1])})})}}).fail(e.exception)},j=function(c,d){a(".launchiconpicker").click(function(e){var j=a(e.currentTarget);"object"!=typeof f?b.render("format_tiles/icon_picker_modal_body",{icon_picker_icons:h}).done(function(b){require(["core/modal_factory"],function(e){e.create({type:e.types.DEFAULT,title:g.pickAnIcon,body:b}).done(function(b){f=b,b.setLarge(),b.show();var e=a(b.root);e.attr("id","icon_picker_modal"),e.attr("data-sectionid",j.attr("data-sectionid")),e.addClass("icon_picker_modal"),e.on("click",".pickericon",function(e){var f=a(e.currentTarget);i(j.attr("data-sectionid"),j.attr("data-section"),f.attr("data-icon"),f.attr("title"),c,d),b.hide()}),e.on("input","input.iconsearch",function(b){var c=b.currentTarget.value.toLowerCase();e.find(".pickericon").show(),c.length>=3&&e.find(".pickericon").filter(function(b,d){return a(d).attr("data-original-title").toLowerCase().indexOf(c)<0}).hide()}),a(".pickericon").tooltip()})})}):(f.root.attr("data-sectionid",j.attr("data-sectionid")),f.root.off("click"),f.root.on("click",".pickericon",function(b){var e=a(b.currentTarget);i(j.attr("data-sectionid"),j.attr("data-section"),e.attr("data-icon"),e.attr("title"),c,d),f.hide()}),f.show())})};return{init:function(b,e){a(document).ready(function(){d.get_string("pickicon","format_tiles").done(function(a){g.pickAnIcon=a}),c.call([{methodname:"format_tiles_get_icon_set",args:{courseid:b}}])[0].done(function(a){var b=JSON.parse(a.icons);Object.keys(b).forEach(function(a){h.push({filename:a,displayname:b[a]})})}),j(e,b)})}}});