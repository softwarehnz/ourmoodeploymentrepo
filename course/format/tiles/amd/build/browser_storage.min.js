define(["jquery","core/str","core/notification"],function(a,b,c){"use strict";var d,e,f,g={local:!1,session:!1},h={GIVEN:"yes",DENIED:"no",userChoice:null},i={prefix:"mdl-",course:"mdl-course-",lastSection:"-lastSecId",content:"-content",lastUpdated:"-lastUpdated",userPrefStorage:"mdl-tiles-userPrefStorage",collapseSecZero:"-collapsesec0",user:"-user-",section:"-sec-"},j=function(){return i.course+d+i.user+e+i.lastSection},k=function(a){return i.course+d+i.section+a.toString()+i.user+e+i.content},l=function(a){return i.course+d+i.section+a.toString()+i.user+e+i.lastUpdated},m=function(){return i.course+d+i.user+e+i.collapseSecZero},n=function(){return i.userPrefStorage+i.user+e},o=function(a){return a.substring(0,4)===i.prefix&&a.substr(-12)===i.lastUpdated},p=function(a,b){var c;if(!b)return!1;try{return"local"===a?c=localStorage:"session"===a&&(c=sessionStorage),"undefined"!=typeof c&&(c.setItem("testItem","testValue"),"testValue"===c.getItem("testItem")&&(c.removeItem("testItem"),!0))}catch(d){return!1}},q=function(a,b,c){c&&""!==c&&g.session?(sessionStorage.setItem(k(b),c),sessionStorage.setItem(l(b),Math.round(Date.now()/1e3).toString())):(sessionStorage.removeItem(k(b)),sessionStorage.removeItem(l(b)))},r=function(a){var b=a.split("-");if(o(a))return{courseId:parseInt(b[2]),sectionId:parseInt(b[4]),userId:parseInt(b[6]),title:b[7]};throw new Error("Invalid lastUpdated key")},s=function(a,b,c){if(b)Object.keys(localStorage).filter(function(a){return a.substring(0,4)===i.prefix&&a!==n()}).forEach(function(a){localStorage.removeItem(a)}),Object.keys(sessionStorage).filter(function(a){return"mdl"===a.split("-")[0]}).forEach(function(a){if(o(a)){var b=r(a);q(b.courseId,b.sectionId,null)}});else{var d=Math.round(Date.now()/1e3)-60*a;Object.keys(sessionStorage).filter(function(a){return"mdl"===a.split("-")[0]}).forEach(function(b){if(o(b)){var c=r(b);(sessionStorage.getItem(b)<d||0===a)&&q(c.courseId,c.sectionId,null)}});var e=Object.keys(sessionStorage).filter(function(a){return o(a)});if(e.length>c){var f=e.map(function(a){return parseInt(sessionStorage[a])}).sort(),g=f[f.length-c];0===c&&(g=Date.now());var h;e.filter(function(a){return sessionStorage[a]<g}).forEach(function(a){h=r(a),q(h.courseId,h.sectionId,null)})}}},t=function(){b.get_strings([{key:"datapref",component:"format_tiles"},{key:"dataprefquestion",component:"format_tiles"},{key:"yes"},{key:"no"}]).done(function(a){c.confirm(a[0],a[1],a[2],a[3],function(){h.userChoice=h.GIVEN,localStorage.setItem(n(),h.GIVEN),g.local=p("local",f),g.session=p("session",f)},function(){h.userChoice=h.DENIED,localStorage.setItem(n(),h.DENIED),s(0,1,0),g.local=0})})},u=function(a){a&&g.local?localStorage.setItem(j(),a.toString()):localStorage.removeItem(j())},v={init:function(b,c,i,j,k,l,m){d=b.toString(),e=m.toString(),f=parseInt(c),h.userChoice=1===parseInt(l)?h.GIVEN:localStorage.getItem(n()),h.userChoice===h.DENIED?(g.local=!1,g.session=0,s(0,1,0)):(g.local=p("local",f),g.session=p("session",f)),a(document).ready(function(){1===l&&(h.userChoice=h.GIVEN),(g.local||g.session)&&null===h.userChoice&&setTimeout(function(){t()},500),a('a[href*="datapref"]').click(function(a){a.preventDefault(),t()}),a("#page").on("click",".togglecompletion",function(b){if(g.local){q(d,0,null);var c=a(b.currentTarget).attr("data-section");setTimeout(function(){q(d,c,a("#section-"+c).html())},1e3)}}),i&&(u(j),s(0,1,0),g.session&&q(d,j,null)),a("#page-content").on("click",".tile",function(){setTimeout(function(){s(parseInt(k),0,f)},2e3)}),a('a.menu-action[data-title="switchroleto,moodle"]').click(function(){s(0,1,0)})})},storageEnabledSession:function(){return g.session},storageEnabledLocal:function(){return g.local},storageUserPreference:function(){return h.userChoice===h.GIVEN},getLastVisitedSection:function(){return localStorage.getItem(j())},getCourseContent:function(a,b){return sessionStorage.getItem(k(b))},getStoredContentAge:function(a,b){var c=parseInt(sessionStorage.getItem(l(b)));return!!c&&Math.round(Date.now()/1e3-c)},setSecZeroCollapseStatus:function(a){g.local&&h.userChoice===h.GIVEN&&("collapsed"===a?localStorage.removeItem(m()):localStorage.setItem(m(),"1"))},getSecZeroCollapseStatus:function(){return!!localStorage.getItem(m())},storeCourseContent:function(a,b,c){h.userChoice===h.GIVEN&&q(a,b,c)},cleanUp:function(a,b,c){s(a,b,c)},launchUserPreferenceWindow:function(){t()},setLastVisitedSection:function(a){h.userChoice===h.GIVEN&&u(a)}};return v});